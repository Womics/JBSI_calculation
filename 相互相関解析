import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from itertools import combinations
from pathlib import Path

# ================================
# â‘  ã‚¹ãƒ‘ã‚¤ã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
# ================================
def load_event_data(file):
    df = pd.read_csv(file)
    if "ROI" in df.columns:
        roi_col = "ROI"
    elif "ROI (box)" in df.columns:
        roi_col = "ROI (box)"
    else:
        raise ValueError("ROIåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    df[roi_col] = df[roi_col].ffill()
    return df, roi_col

def make_cell_df(evt_df, roi_id, roi_col="ROI", time_col="time"):
    return (evt_df[evt_df[roi_col] == roi_id]
            [[time_col]]
            .rename(columns={time_col: "spike_time_s"})
            .reset_index(drop=True))

def compute_cross_correlogram(spike_times_1, spike_times_2,
                              window_ms=100, bin_width_ms=1):
    t1_ms = np.array(spike_times_1) * 1000
    t2_ms = np.array(spike_times_2) * 1000
    lags = []
    for t in t1_ms:
        diff = t2_ms - t
        mask = np.abs(diff) <= window_ms
        lags.extend(diff[mask])
    bins = np.arange(-window_ms, window_ms + bin_width_ms, bin_width_ms)
    counts, _ = np.histogram(lags, bins=bins)
    return counts

# ================================
# â‘¡ ãƒã‚¹ã‚¿ãƒ¼æ¡ä»¶ã‚’ãƒ­ãƒ¼ãƒ‰
# ================================
# masterãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆExcelæƒ³å®šã€ã‚¿ãƒ–æŒ‡å®šï¼‰
master = pd.read_excel("YOUR_FILE_NAME",
                       sheet_name="each_detected_spikes")

# data_uid = "data001"ã€œ
# Håˆ—: è£œæ­£å¾Œè¨˜éŒ²æ™‚é–“ [s]
# Måˆ—: sparseplot

# ================================
# â‘¢ ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
# ================================
window_ms    = 500
bin_width_ms = 3
bin_edges    = np.arange(-window_ms, window_ms + bin_width_ms, bin_width_ms)
bin_centers  = bin_edges[:-1] + bin_width_ms/2
bin_width_s  = bin_width_ms / 1000.0   # binå¹…ã‚’ç§’ã«å¤‰æ›

results = {}  # {(Anesthesia, different, sparseplot): [rate histograms...]}

for num in range(1, 61):
    file = Path(f"./learner_out_schmitt/timelapse_data{num:03d}_spikes_detected.csv")
    if not file.exists():
        print(f"âš  {file.name} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        continue

    evt, roi_col = load_event_data(file)
    if evt.empty:
        print(f"âš  {file.name} ã¯ç©ºã§ã™")
        continue

    roi_ids = sorted(evt[roi_col].dropna().unique())
    if len(roi_ids) < 2:
        print(f"âš  {file.name} ã¯ ROI ãŒ1ç¨®é¡ä»¥ä¸‹ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—")
        continue

    cell_spike_dict = {roi: make_cell_df(evt, roi, roi_col=roi_col, time_col="time") 
                       for roi in roi_ids}

    # masteræ¡ä»¶ã‚’å–å¾—
    data_uid = f"data{num:03d}"
    subset = master[master["data_uid"] == data_uid]
    if subset.empty:
        print(f"âš  {file.name} ã«å¯¾å¿œã™ã‚‹è¡ŒãŒ master ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        continue

    cond_row = subset.iloc[0]
    cond_label = (cond_row["Anesthesia"], cond_row["different"], cond_row["sparseplot"])
    recording_time = cond_row["è£œæ­£å¾Œè¨˜éŒ²æ™‚é–“"]  # Håˆ—

    # å„ROIãƒšã‚¢ã§ã‚³ãƒ¬ãƒ­ã‚°ãƒ©ãƒ 
    for roi1, roi2 in combinations(roi_ids, 2):
        spikes1 = cell_spike_dict[roi1]["spike_time_s"]
        spikes2 = cell_spike_dict[roi2]["spike_time_s"]
        if spikes1.empty or spikes2.empty:
            continue
        counts = compute_cross_correlogram(spikes1, spikes2,
                                           window_ms=window_ms,
                                           bin_width_ms=bin_width_ms)
        # ç™ºç«ç‡ (Hz) ã«æ›ç®—: counts / (recording_time * binå¹…[s])
        rate = counts / recording_time
        results.setdefault(cond_label, []).append(rate)

    print(f"âœ” {file.name} processed")

# ================================
# â‘£ æ¡ä»¶ã”ã¨ã®å¹³å‡ãƒ—ãƒ­ãƒƒãƒˆ & ä¿å­˜
# ================================
outdir = Path("crosscorr_out_hz")
outdir.mkdir(exist_ok=True, parents=True)

for cond_label, all_rates in results.items():
    all_rates_array = np.vstack(all_rates)
    mean_rate   = np.mean(all_rates_array, axis=0)
    stderr_rate = np.std(all_rates_array, axis=0, ddof=1) / np.sqrt(all_rates_array.shape[0])

    plt.figure(figsize=(5, 4))
    plt.plot(bin_centers, mean_rate, label="Mean rate",c="black")
    plt.fill_between(bin_centers,
                     mean_rate - stderr_rate,
                     mean_rate + stderr_rate,
                     color='gray', alpha=0.3, label="Â±SEM")
    plt.xlabel("Time lag (ms)")
    plt.ylabel("Spike rate (counts/s)")
    plt.title(f"Cross-Correlogram (Hz): Anes={cond_label[0]}, diff={cond_label[1]}, sparse={cond_label[2]}")
    plt.axvline(0, color='k', linestyle='--', linewidth=0.8)
    plt.xlim(-window_ms, window_ms)
    plt.grid(True)
    plt.legend()
    plt.tight_layout()
    plt.show()

    fname = f"crosscorr_A{cond_label[0]}_D{cond_label[1]}_S{cond_label[2]}.png"
    save_path = outdir / fname
    plt.savefig(save_path, dpi=150)
    plt.close()
    print(f"ğŸ’¾ Saved: {save_path.resolve()}")

print("=== å…¨æ¡ä»¶ã®ã‚¯ãƒ­ã‚¹ã‚³ãƒ¬ãƒ­ã‚°ãƒ©ãƒ  (Hzæ›ç®—) ä¿å­˜å®Œäº† ===")
